stages:
  - build

variables:
  BUILD_DIR: "build"
  ARTIFACT_PATH: "dist"
  ARTIFACT_NAME: "kcast-runtime.tar.gz"

# Nur auf Tags triggern
build_tarball:
  stage: build
  only:
    - tags
  tags:
    - shell
  script:
    - echo "ğŸ“ Projektstruktur (ls -l)"
    - ls -l
    - echo "ğŸ”§ Erstelle Build-Verzeichnis:"
    - mkdir -p "${BUILD_DIR}"
    - echo "ğŸ› ï¸ Starte CMake-Konfiguration"
    - cmake -B "${BUILD_DIR}" -DCMAKE_BUILD_TYPE=Release
    - echo "âš™ï¸ Baue Projekt"
    - cmake --build "${BUILD_DIR}" --parallel
    - echo "ğŸ§ª PrÃ¼fe Build-Ergebnisse"
    - ls -lh "${BUILD_DIR}/bin/de/agundur/kcast/libkcastplugin.so" || (echo "âŒ .so not found!" && exit 1)
    - ls -lh package/metadata.json || (echo "âŒ metadata.json not found!" && exit 1)
    - ls -lh package/contents/ui || (echo "âŒ UI-Verzeichnis fehlt!" && exit 1)
    - echo "ğŸ“¦ Erstelle Tarball"
    - mkdir -p "${ARTIFACT_PATH}"
    - tar czf "${ARTIFACT_PATH}/${ARTIFACT_NAME}" \
        "${BUILD_DIR}/bin/de/agundur/kcast/libkcastplugin.so" \
        package/metadata.json \
        package/contents/ui
    - echo "âœ… Fertig gebaut: ${ARTIFACT_PATH}/${ARTIFACT_NAME}"

  artifacts:
    paths:
      - "${ARTIFACT_PATH}/${ARTIFACT_NAME}"
    expire_in: 1 week
