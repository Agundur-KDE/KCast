workflow:
  rules:
    - if: '$CI_COMMIT_TAG'  # nur bei Git-Tags ausf√ºhren

variables:
  BUILD_DIR: build
  ARTIFACT_PATH: dist
  ARTIFACT_NAME: kcast-runtime.tar.gz

build_tarball:
  tags:
    - shell
  script:
    - echo "üìÅ Arbeitsverzeichnis: $PWD"
    - echo "üì¶ Setze Buildverzeichnis: $BUILD_DIR"
    - cmake -B $BUILD_DIR -DCMAKE_BUILD_TYPE=Release
    - cmake --build $BUILD_DIR --parallel
    - echo "‚úÖ Build abgeschlossen"

    # Tests: Existenz pr√ºfen
    - ls -lh $BUILD_DIR/bin/de/agundur/kcast/libkcastplugin.so || (echo "‚ùå .so fehlt!" && exit 1)
    - ls -lh package/metadata.json || (echo "‚ùå metadata.json fehlt!" && exit 1)
    - ls -lh package/contents/ui || (echo "‚ùå UI-Verzeichnis fehlt!" && exit 1)

    # Tarball bauen
    - mkdir -p $ARTIFACT_PATH
    - tar czf $ARTIFACT_PATH/$ARTIFACT_NAME \
        $BUILD_DIR/bin/de/agundur/kcast/libkcastplugin.so \
        package/metadata.json \
        package/contents/ui

    - echo "üì¶ Tarball erstellt: $ARTIFACT_PATH/$ARTIFACT_NAME"

  artifacts:
    paths:
      - dist/kcast-runtime.tar.gz
    expire_in: 1 week
    name: "$CI_PROJECT_NAME-$CI_COMMIT_TAG"

  rules:
    - if: '$CI_COMMIT_TAG'
