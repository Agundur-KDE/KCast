stages:
  - build

variables:
  BUILD_DIR: build
  ARTIFACT_PATH: dist
  ARTIFACT_NAME: kcast-runtime.tar.gz

build_tarball:
  stage: build
  tags:
    - shell
  only:
    - tags
  script:
    - echo "ğŸ“‚ Arbeitsverzeichnis: $(pwd)"
    - echo "ğŸ“ Projektstruktur:"
    - ls -l
    - echo "ğŸ” Suche nach QML-Dateien:"
    - find . -name "*.qml"

    - cmake -B $BUILD_DIR -DCMAKE_BUILD_TYPE=Release
    - cmake --build $BUILD_DIR --parallel

    - ls -lh $BUILD_DIR/bin/de/agundur/kcast/libkcastplugin.so || (echo "âŒ .so not found!" && exit 1)
    - ls -lh package/metadata.json || (echo "âŒ metadata.json not found!" && exit 1)
    - ls -lh package/contents/ui || (echo "âŒ UI-Verzeichnis fehlt!" && exit 1)

    - mkdir -p $ARTIFACT_PATH
    - tar czf $ARTIFACT_PATH/$ARTIFACT_NAME \
        $BUILD_DIR/bin/de/agundur/kcast/libkcastplugin.so \
        package/metadata.json \
        package/contents/ui
  artifacts:
    paths:
      - dist/kcast-runtime.tar.gz
    expire_in: 7 days
